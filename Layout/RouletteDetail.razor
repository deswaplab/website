@inject Web3Service _web3Service
@inject ILogger<RouletteDetail> Logger
@inject MetamaskHostProvider _metamaskHostProvider
@inject IMetamaskInterop _metamaskInterop;
@inject ToastService toastService
@inject IStringLocalizer<SharedResource> Loc
@inject Web3Service _web3Service
@inject NftApi _nftFetcher

<div class="mx-auto flex flex-col items-center py-2 max-w-sm bg-white rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
    @if (Token is null)
    {
        <img class="rounded-t-lg"
             src="@DefaultImage"
             alt="">
    }
    else
    {
        if (!string.IsNullOrEmpty(NftUrl))
        {
            <a href="@NftUrl">
                <img class="rounded-t-lg"
                     src="@Token.ImageData"
                     alt="">
            </a>
        }
        else
        {
            <img class="rounded-t-lg"
                 src="@Token.ImageData"
                 alt="">
        }

        <div class="flex flex-row items-center justify-center gap-2 p-5">
            <button type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                    @onclick="() => OpenModal(Token)">
                @Loc["Bet_Stmt"]
            </button>
            @if (Token.Openable(_metamaskHostProvider.SelectedAccount))
            {
                <button type="button" class="@OpenButtonClass inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                        @onclick="async () => await HandleOpen(Token)"
                        disabled=@OpenButtonDisabled>
                    @Loc["Open_Stmt"]
                </button>
            }
        </div>

        <div id="authentication-modal" tabindex="-1" aria-hidden="true" class="@ShowModalClass overflow-y-auto overflow-x-auto fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
            <div class="relative p-4 w-full max-w-md max-h-full">
                <!-- Modal content -->
                <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                    <!-- Modal header -->
                    <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                            Bet
                        </h3>
                        <button type="button" class="end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="authentication-modal"
                                @onclick="CloseModal">
                            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                            </svg>
                            <span class="sr-only">Close</span>
                        </button>
                    </div>
                    <!-- Modal body -->
                    <div class="p-4 md:p-5">
                        <form class="space-y-4">
                            <div>
                                <label for="amount" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">@CurAssetSymbol</label>
                                <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required
                                       @bind-value:get="InputedBaseAssetAmount" @bind-value:set="SetInputedBaseAssetAmount"
                                       min="0.001" max="10000000" step="0.001" />
                            </div>
                            <button type="button" class="@BetButtonClass w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                                    @onclick="async () => await HandleBet(Token)"
                                    disabled=@BetButtonDisabled>
                                Submit
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string DefaultImage = "data:image/svg+xml;base64,PHN2ZyBmaWxsPSIjMDAwMDAwIiB3aWR0aD0iODAwcHgiIGhlaWdodD0iODAwcHgiIHZpZXdCb3g9IjAgMCAzMiAzMiIgaWQ9Imljb24iIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHN0eWxlPi5jbHMtMXtmaWxsOm5vbmU7fTwvc3R5bGU+PC9kZWZzPjx0aXRsZT5uby1pbWFnZTwvdGl0bGU+PHBhdGggZD0iTTMwLDMuNDE0MSwyOC41ODU5LDIsMiwyOC41ODU5LDMuNDE0MSwzMGwyLTJIMjZhMi4wMDI3LDIuMDAyNywwLDAsMCwyLTJWNS40MTQxWk0yNiwyNkg3LjQxNDFsNy43OTI5LTcuNzkzLDIuMzc4OCwyLjM3ODdhMiwyLDAsMCwwLDIuODI4NCwwTDIyLDE5bDQsMy45OTczWm0wLTUuODMxOC0yLjU4NTgtMi41ODU5YTIsMiwwLDAsMC0yLjgyODQsMEwxOSwxOS4xNjgybC0yLjM3Ny0yLjM3NzFMMjYsNy40MTQxWiIvPjxwYXRoIGQ9Ik02LDIyVjE5bDUtNC45OTY2LDEuMzczMywxLjM3MzMsMS40MTU5LTEuNDE2LTEuMzc1LTEuMzc1YTIsMiwwLDAsMC0yLjgyODQsMEw2LDE2LjE3MTZWNkgyMlY0SDZBMi4wMDIsMi4wMDIsMCwwLDAsNCw2VjIyWiIvPjxyZWN0IGlkPSJfVHJhbnNwYXJlbnRfUmVjdGFuZ2xlXyIgZGF0YS1uYW1lPSImbHQ7VHJhbnNwYXJlbnQgUmVjdGFuZ2xlJmd0OyIgY2xhc3M9ImNscy0xIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiLz48L3N2Zz4K";

    [Parameter]
    public string ContractAddress { get; set; } = "";

    [Parameter]
    public long TokenId { get; set; }

    [Parameter]
    public string NetworkName { get; set; } = "";

    public Network? SelectedNetwork { get; set; }

    public string NftUrl => SelectedNetwork is not null ? SelectedNetwork.BuildNftUrl(ContractAddress, TokenId) : "";

    public UserRouletteNFT? Token { get; set; }

    private string CurAssetSymbol => Token is not null ? new RouletteContracts().Inner.Where(p => p.Address.Equals(Token.Contract, StringComparison.CurrentCultureIgnoreCase))
        .Select(p => p.BaseAsset.Name)
        .First() : "Asset";

    protected override void OnInitialized()
    {
        _metamaskHostProvider.NetworkChanged += MetamaskHostProvider_NetworkChainIdChanged;
        _metamaskHostProvider.SelectedAccountChanged += MetamaskHostProvider_SelectedAccountChanged;
    }

    private async Task MetamaskHostProvider_SelectedAccountChanged(string account)
    {
        await InvokeAsync(() => this.StateHasChanged());
    }

    private async Task MetamaskHostProvider_NetworkChainIdChanged(long chainId)
    {
        var targetNetwork = SupportedNetworks.GetNetworkByName(NetworkName);
        if (targetNetwork is not null && targetNetwork.ChainId != chainId)
        {
            var p = new Dictionary<string, string>();
            p.Add("chainId", "0x" + Convert.ToString(targetNetwork.ChainId, 16));
            await _metamaskInterop.SendAsync(new Nethereum.JsonRpc.Client.RpcMessages.RpcRequestMessage(null, "wallet_switchEthereumChain", p));
        }

        // 发请求取图片信息，更新页面
        string metadataUri = await _web3Service.GetUri(ContractAddress, TokenId);
        Token = UserRouletteNFT.FromStr(chainId, ContractAddress, TokenId, metadataUri);
        await InvokeAsync(() => this.StateHasChanged());
    }

    public void Dispose()
    {
        _metamaskHostProvider.NetworkChanged -= MetamaskHostProvider_NetworkChainIdChanged;
        _metamaskHostProvider.SelectedAccountChanged -= MetamaskHostProvider_SelectedAccountChanged;
    }

    private bool IsShowModal = false;

    private string ShowModalClass => IsShowModal ? "" : "hidden";

    private bool BetButtonDisabled = false;

    private string BetButtonClass => BetButtonDisabled ? "cursor-not-allowed" : "";

    private void OpenModal(UserRouletteNFT token)
    {
        IsShowModal = true;
    }

    private void CloseModal()
    {
        IsShowModal = false;
    }

    public decimal InputedBaseAssetAmount { get; set; } = 0m;

    private void SetInputedBaseAssetAmount(decimal value)
    {
        InputedBaseAssetAmount = value;
    }

    private async Task HandleBet(UserRouletteNFT token)
    {
        var selecteContract = new RouletteContracts().Inner.Where(p => p.Address.Equals(token.Contract, StringComparison.CurrentCultureIgnoreCase))
            .First();
        var wad = Web3.Convert.ToWei(InputedBaseAssetAmount, selecteContract.BaseAsset.Decimals);
        string baseAssetContract = selecteContract.BaseAsset.Address;
        BetButtonDisabled = true;
        try
        {
            var allowance = await _web3Service.GetAllowance(_metamaskHostProvider.SelectedAccount, token.Contract, baseAssetContract);
            if (allowance < wad)
            {
                await _web3Service.Approve(token.Contract, wad, baseAssetContract);
            }
            var txHash = await _web3Service.BetRoulette(
                wad,
                token.TokenId,
                token.Contract
            );
            toastService.ShowToast($"Token: {token.TokenId} {Loc["TxSuccess_Stmt"]}", ToastLevel.Success);
        }
        catch (Nethereum.JsonRpc.Client.RpcResponseException e)
        {
            if (e.Message.Contains("User denied transaction signature"))
            {
                toastService.ShowToast(Loc["TxCancelled_Stmt"], ToastLevel.Error);
            }
        }
        CloseModal();
        BetButtonDisabled = false;
        await Task.Delay(1000);
        await _nftFetcher.RefreshMetadata(token.Contract, token.ChainId, token.TokenId);
    }

    private bool OpenButtonDisabled = false;

    private string OpenButtonClass => OpenButtonDisabled ? "cursor-not-allowed" : "";

    private async Task HandleOpen(UserRouletteNFT token)
    {
        OpenButtonDisabled = true;
        try
        {
            var txHash = await _web3Service.OpenRoulette(
                token.TokenId,
                token.Contract
            );
            toastService.ShowToast($"Token: {token.TokenId} {Loc["TxSuccess_Stmt"]}", ToastLevel.Success);

            await Task.Delay(1000);
            await _nftFetcher.RefreshMetadata(token.Contract, token.ChainId, token.TokenId);
        }
        catch (Nethereum.JsonRpc.Client.RpcResponseException e)
        {
            if (e.Message.Contains("User denied transaction signature"))
            {
                toastService.ShowToast(Loc["TxCancelled_Stmt"], ToastLevel.Error);
            }
        }
        OpenButtonDisabled = false;
    }
}