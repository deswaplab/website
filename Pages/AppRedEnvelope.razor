@using Nethereum.Web3
@using Nethereum.Contracts.CQS
@using Nethereum.Util
@using Nethereum.Web3.Accounts
@using Nethereum.Hex.HexConvertors.Extensions
@using Nethereum.Contracts
@using Nethereum.Contracts.Extensions
@using System.Numerics
@using System.Security.Claims
@using DeswapApp.Pages
@using DeswapApp.Localization

@page "/app/redenvelope"

@layout AppLayout
@inject ILogger<AppRedEnvelope> Logger
@inject MetamaskHostProvider _metamaskHostProvider
@inject AuthenticationStateProvider _authenticationStateProvider
@inject IJSRuntime JS
@inject ToastService toastService
@inject Web3Service _web3Service
@inject IStringLocalizer<SharedResource> Loc
@inject PriceService _priceService
<PageTitle>@Loc["RedEnvelope"]</PageTitle>

<section class="bg-gray-50 dark:bg-gray-900">
    <div class="flex flex-col items-center justify-center px-6 py-8 mx-auto md:h-screen lg:py-0">
        <CascadingAuthenticationState>
            <AuthorizeView Roles="EthereumConnected">
                <Authorized>
                    <div class="w-full bg-white rounded-lg shadow dark:border md:mt-0 sm:max-w-md xl:p-0 dark:bg-gray-800 dark:border-gray-700">
                        <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
                            <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl dark:text-white">
                                @Loc["RedEnvelope"]
                            </h1>
                            <form class="space-y-4 md:space-y-6">
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">@Loc["Select Token Pair"]</label>
                                    <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                        @bind:get="SelectedLotteryContractName"
                                        @bind:event="onchange"
                                        @bind:set="ChangeSelectedLotteryContractName"
                                        >
                                        <option></option>
                                        @foreach(var contract in AllLotteryContracts)
                                        {
                                            <option value="@contract.Name">@contract.Name</option>
                                        }
                                    </select>
                                </div>

                                <div>
                                    <label for="baseAsset" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white flex flex-row justify-between">
                                        @if (SelectedLotteryContract is not null) {
                                            <span>@SelectedLotteryContract.BaseAssetName</span>
                                        } else {
                                            <span>Asset</span>
                                        }
                                        <span>
                                            @if(UserBaseAssetBalance is not null) {
                                                <a class="font-medium text-blue-600 hover:underline dark:text-blue-500" href="@SelectedLotteryContract!.GetEtherScanTokenBalanceUrl(@SelectedLotteryContract.BaseAssetAddress, @_metamaskHostProvider.SelectedAccount)" target="_blank">@Loc["Balance"]: @UserBaseAssetBalance</a>
                                            }
                                        </span>
                                        
                                    </label>
                                    <input type="number" name="baseAssetAmount" id="baseAssetAmount"
                                        class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                        required @bind-value:get="InputedBaseAssetAmount" @bind-value:set="SetInputedBaseAssetAmount"
                                        min="0.001" max="10000000" step="0.001"
                                    >
                                    @if(UserBaseAssetBalance == new Decimal(0))
                                    {
                                        <p id="helper-text-explanation" class="mt-2 text-sm text-gray-500 dark:text-gray-400">@Loc["BalanceIsEmpty_Stmt"]</p>
                                    }
                                </div>

                                <div>
                                    <label for="amount" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">@Loc["MintAmount"]</label>
                                    <input type="number" name="amount"
                                        class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                        required @bind-value="InputedAmount"
                                        min="1" max="1000" step="1"
                                    >
                                </div>

                                <div>
                                    <label for="kind" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">@Loc["RedEnvelope Kind"]</label>
                                    <div class="flex">
                                        @foreach(var item in AllKinds)
                                        {
                                            <div class="flex items-center me-4">
                                                <input type="radio" @onchange="@(() => SelectedKind = item)" checked="@(item.Equals(SelectedKind))" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                                <label for="inline-radio" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">@item</label>
                                            </div>
                                        }
                                    </div>
                                </div>

                            </form>
                            <ol class="space-y-4 md:space-y-6">
                                <li>
                                    <MintProgressButton Text=@($"1. {Loc["Check Allowance"]}") CurrentProgress="@Steps[0]" ClickCallback="CheckAllowance" />
                                </li>
                                <li>
                                    <MintProgressButton Text=@($"2. {Loc["Approve"]}") CurrentProgress="@Steps[1]" ClickCallback="Approve" />
                                </li>
                                <li>
                                    <MintProgressButton Text=@($"3. {Loc["Mint"]}") CurrentProgress="@Steps[2]" ClickCallback="Mint" />
                                </li>
                            </ol>
                        </div>
                    </div>
                    <SingleToast />
                </Authorized>
                <NotAuthorized>
                    <LoginButton />
                </NotAuthorized>
            </AuthorizeView>
        </CascadingAuthenticationState>
    </div>
</section>

@code {
    protected override void OnInitialized()
    {
        _metamaskHostProvider.NetworkChanged += MetamaskHostProvider_NetworkChainIdChanged;
        _metamaskHostProvider.SelectedAccountChanged += MetamaskHostProvider_SelectedAccountChanged;
    }

    private async Task MetamaskHostProvider_SelectedAccountChanged(string account)
    {
        // 通知到这个组件更新状态
        await InvokeAsync(() => this.StateHasChanged());
    }

    private async Task MetamaskHostProvider_NetworkChainIdChanged(long chainId)
    {
        await InvokeAsync(() => this.StateHasChanged());
    }

    public void Dispose()
    {
        _metamaskHostProvider.NetworkChanged -= MetamaskHostProvider_NetworkChainIdChanged;
        _metamaskHostProvider.SelectedAccountChanged -= MetamaskHostProvider_SelectedAccountChanged;
    }

    public IList<RedEnvelopeContract> AllLotteryContracts => RedEnvelopeContracts.Inner
        .Where(p => p.Network.ChainId == _metamaskHostProvider.SelectedNetworkChainId)
        .ToList();

    public IList<int> AllAmounts = [100, 1000];

    public int InputedAmount = 100;

    public decimal InputedBaseAssetAmount {get; set;} = 0m;

    private void SetInputedBaseAssetAmount(decimal value)
    {
        if (UserBaseAssetBalance is not null)
        {
            if (value >= UserBaseAssetBalance)
            {
                InputedBaseAssetAmount = UserBaseAssetBalance.Value;
            } else if (value <= 0)
            {
                InputedBaseAssetAmount = 0;
            } else {
                InputedBaseAssetAmount = value;
            }
        } else {
            InputedBaseAssetAmount = 0;
        }
        ResetSteps();
    }

    public RedEnvelopeContract? SelectedLotteryContract {get; set;} = null;

    public string SelectedLotteryContractName {get; set;} = "";

    public async Task ChangeSelectedLotteryContractName(string value)
    {
        SelectedLotteryContractName = value;
        SelectedLotteryContract = AllLotteryContracts.Where(p => p.Name == value).First();

        var baseBalanceInWei = await _web3Service.GetUserBalance(_metamaskHostProvider.SelectedAccount, SelectedLotteryContract.BaseAssetAddress);
        UserBaseAssetBalance = Web3.Convert.FromWei(baseBalanceInWei, SelectedLotteryContract.BaseAssetDecimals);
        Logger.LogInformation($"get balance: {UserBaseAssetBalance}");
    }

    public decimal? UserBaseAssetBalance {get; set;}

    public bool IsFormValid => SelectedLotteryContract is not null && InputedBaseAssetAmount > 0 && InputedAmount >= 1;

    public IList<RedEnvelopeKind> AllKinds = [RedEnvelopeKind.Fixed, RedEnvelopeKind.Random];

    public RedEnvelopeKind SelectedKind = RedEnvelopeKind.Fixed;

    public MintProgressButton.Progress[] Steps = [
        MintProgressButton.Progress.NotStarted,
        MintProgressButton.Progress.NotStarted,
        MintProgressButton.Progress.NotStarted,
    ];

    private void ResetSteps()
    {
        Steps = [
            MintProgressButton.Progress.NotStarted,
            MintProgressButton.Progress.NotStarted,
            MintProgressButton.Progress.NotStarted,
        ];
        if (IsFormValid)
        {
            Steps[0] = MintProgressButton.Progress.ToStart;
        }
    }

    private bool isSupportedNetwork()
    {
        Logger.LogInformation("start check supported chain");
        var currentNetwork = SupportedNetworks.GetNetwork(_metamaskHostProvider.SelectedNetworkChainId);
        if (currentNetwork is not null)
        {
            return true;
        }
        return false;
    }

    private async Task CheckAllowance(MouseEventArgs e)
    {
        if (!isSupportedNetwork())
        {
            toastService.ShowToast(@Loc["InvalidNetwork_Stmt"], ToastLevel.Error);
            return;
        }
        Steps[0] = MintProgressButton.Progress.InProgress; // 一点击就该置灰

        if (InputedBaseAssetAmount <= UserBaseAssetBalance)
        {
            Logger.LogInformation($"user base balance is ok, {_metamaskHostProvider.SelectedAccount}, {SelectedLotteryContract!.NftAddress}, {SelectedLotteryContract.BaseAssetAddress}");
            var baseAssetAllowanceWei = await _web3Service.GetAllowance(_metamaskHostProvider.SelectedAccount, SelectedLotteryContract.NftAddress, SelectedLotteryContract.BaseAssetAddress);
            var baseAssetAllowance = Web3.Convert.FromWei(baseAssetAllowanceWei, SelectedLotteryContract.BaseAssetDecimals);
            Logger.LogInformation($"weth allowance={baseAssetAllowance}");
            if (baseAssetAllowance >= InputedBaseAssetAmount)
            {
                Logger.LogInformation($"base allowance is enough, skip approve step");
                Steps[0] = MintProgressButton.Progress.Finished;
                Steps[1] = MintProgressButton.Progress.Finished;
                Steps[2] = MintProgressButton.Progress.ToStart;
            }
            else
            {
                Steps[0] = MintProgressButton.Progress.Finished;
                Steps[1] = MintProgressButton.Progress.ToStart;
            }
        }
    }

    private async Task Approve()
    {
        Logger.LogInformation("Approve");   
        if (!isSupportedNetwork())
        {
            toastService.ShowToast(Loc["InvalidNetwork_Stmt"], ToastLevel.Error);
            return;
        }
        Steps[1] = MintProgressButton.Progress.InProgress; // 一点击就该置灰
        var wad = Web3.Convert.ToWei(InputedBaseAssetAmount, SelectedLotteryContract!.BaseAssetDecimals);
        var contractAddress = SelectedLotteryContract!.BaseAssetAddress;
        try {
            var txHash = await _web3Service.Approve(SelectedLotteryContract!.NftAddress, wad, contractAddress);
            Logger.LogInformation($"approve finished, tx: {txHash}");
            await Task.Delay(1000);
            // check allowance again
            var newAllowance = await _web3Service.GetAllowance(_metamaskHostProvider.SelectedAccount, SelectedLotteryContract!.NftAddress, contractAddress);
            if (newAllowance < wad)
            {
                // 没有授权足够的金额
                toastService.ShowToast(Loc["InsufficientAllowance_Stmt"], ToastLevel.Error);
                Steps[1] = MintProgressButton.Progress.ToStart; // 让用户重新开始再来一遍
                return;
            }

            // 标记完成，且让第三步可点击
            Steps[1] = MintProgressButton.Progress.Finished;
            Steps[2] = MintProgressButton.Progress.ToStart;

            toastService.ShowToast(Loc["ApproveSuccess_Stmt"], ToastLevel.Success);
        } catch (Nethereum.JsonRpc.Client.RpcResponseException e) {
            if (e.Message.Contains("User denied transaction signature"))
            {
                toastService.ShowToast(Loc["TxCancelled_Stmt"], ToastLevel.Error);
            }
            Steps[1] = MintProgressButton.Progress.ToStart; // 让用户重来一次
        }
    }

    private async Task Mint()
    {
        // TODO:
        Logger.LogInformation("Mint");
        await Task.CompletedTask;
        if (!isSupportedNetwork())
        {
            toastService.ShowToast(Loc["InvalidNetwork_Stmt"], ToastLevel.Error);
            return;
        }
        Steps[2] = MintProgressButton.Progress.InProgress; // 一点击就该置灰
        try {
            var txHash = await _web3Service.MintRedEnvelope(
                Web3.Convert.ToWei(InputedBaseAssetAmount, SelectedLotteryContract!.BaseAssetDecimals), 
                InputedAmount,
                SelectedKind,
                SelectedLotteryContract!.NftAddress
            );

            Logger.LogInformation($"mint finished, tx: {txHash}");
            Steps[2] = MintProgressButton.Progress.Finished;

            toastService.ShowToast(Loc["OptionsMinted_Stmt"], ToastLevel.Success);
        } catch (Nethereum.JsonRpc.Client.RpcResponseException e) {
            if (e.Message.Contains("User denied transaction signature"))
            {
                toastService.ShowToast(Loc["TxCancelled_Stmt"], ToastLevel.Error);
            }
            Steps[2] = MintProgressButton.Progress.ToStart;
        }
    }
}
